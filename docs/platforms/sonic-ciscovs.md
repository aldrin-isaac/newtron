# SONiC CiscoVS Platform Guide

## Overview

**Platform ID:** `sonic-ciscovs`
**Dataplane:** Cisco Silicon One Virtual PFE (NGDP)
**HWSKU:** cisco-8101-p4-32x100-vs (Gibraltar), cisco-p200-32x100-vs (Palladium2)
**Hardware Model:** Cisco 8223-x (Palladium2 ASIC)
**SONiC Version:** 202505 (Cisco branch)
**Use Cases:** EVPN fabrics, full SONiC feature testing, production-like validation

## Quick Reference

| Feature | Support | Notes |
|---------|---------|-------|
| L3 Routing | ✅ Yes | Full support |
| BGP (IPv4) | ✅ Yes | Full support |
| EVPN/VXLAN | ✅ Yes | Primary use case |
| ACLs | ⚠️ TBD | Expected to work |
| MAC-VPN | ✅ Yes | VXLAN-based |
| Static Routes | ✅ Yes | Full support |
| Port Channels | ✅ Yes | Full support |
| VRFs | ✅ Yes | Full support |

## Known Limitations

### 1. Slower Boot Time

**Issue:** Silicon One SAI initialization is slower than standard VS.

**Impact:**
- Boot time: 5-10 minutes (vs 1-2 min for VPP)
- Higher resource requirements
- Slower test iteration

**Workaround:**
- Use VPP for quick L3 routing tests
- Reserve CiscoVS for EVPN/full feature testing
- Increase boot timeout to 600s in platforms.json

### 2. Higher Resource Requirements

**Issue:** NGDP simulator requires more CPU and memory.

**Requirements:**
- **Minimum:** 2 vCPU, 6GB RAM
- **Allocated:** 6 vCPU, 8GB RAM (current newtrun topology defaults)

**Impact:**
- Cannot run many VMs simultaneously
- Host must have sufficient resources
- Slower on under-resourced hosts

**Workaround:** Use VPP for parallel testing, CiscoVS for targeted EVPN tests.

### 3. Orchagent Timeout Increased

**Issue:** Silicon One SAI is slower than standard VS SAI.

**Impact:**
- Default orchagent timeout (30s) too short
- Operations may timeout unnecessarily

**Fix Applied:**
- Patched to 60s timeout for CiscoVS builds
- Included in boot patches

### 4. All Ports Exist Regardless of NICs

**Difference from VPP:** VPP creates ports = NIC count. CiscoVS always has 32 ports.

**Impact:**
- Unused ports exist in CONFIG_DB
- NIC count doesn't affect port availability
- More flexible but less realistic

**Benefit:** Can provision fewer NICs, still access all 32 ports.

## Configuration Requirements

### platforms.json Entry

```json
{
  "ciscovs": {
    "hwsku": "cisco-p200-32x100-vs",
    "description": "SONiC 202505 with Cisco Silicon One virtual PFE (Palladium2)",
    "port_count": 32,
    "default_speed": "100G",
    "vm_image": "~/.newtlab/images/sonic-ciscovs.qcow2",
    "vm_memory": 8192,
    "vm_cpus": 6,
    "vm_nic_driver": "e1000",
    "vm_interface_map": "sequential",
    "vm_credentials": {"user": "admin", "pass": "YourPaSsWoRd"},
    "vm_boot_timeout": 600,
    "dataplane": "ciscovs",
    "unsupported_features": []
  }
}
```

**HWSKU selects PFE mode.** The image ships with three Silicon One ASIC
models. Changing the `hwsku` field selects which NGDP simulator runs.
See [RCA-040](../rca/040-ciscovs-pfe-mode-selection.md) for details.

| HWSKU | PFE Mode | Hardware Reference |
|-------|----------|-------------------|
| `cisco-p200-32x100-vs` | Palladium2 | Cisco 8223-x |
| `cisco-8101-p4-32x100-vs` | Gibraltar | Cisco 8101-32FH-O |
| `cisco-gr2-32x100-vs` | GR2 | Cisco 8122-64EH-O |

**Key Differences from VPP:**
- Higher memory (8GB vs 4GB)
- More CPUs (6 vs 4)
- Longer boot timeout (600s vs 300s)
- NIC driver: e1000 (not virtio-net-pci)
- No unsupported features (full SONiC support expected)

### Boot Patches

Located in `pkg/newtlab/patches/ciscovs/always/`:

| Patch | Description |
|-------|-------------|
| `00-frrcfgd-mode.json` | Enable unified FRR mode (`docker_routing_config_mode=unified` + `frr_mgmt_framework_config=true`), restart bgp container |
| `01-frrcfgd-vni-bootstrap.json` | Deploy `newtron-vni-poll` thread in frrcfgd for L3VNI binding (workaround for broken frrcfgd `vrf_handler` pub/sub) |
| `02-wait-swss.json` | Wait for SwSS container to be ready before deploy completes (up to 5 min) |

**Note:** System MAC is no longer handled by a boot patch. MAC is generated by newtlab
`PatchProfiles()` at deploy time and flows through the profile → composite → DEVICE_METADATA path.

## Build Information

### SAI Tarball

**Location:** `/home/aldrin/Downloads/ciscovs-202505-palladium2-25.9.1000.2-sai-1.16.1.tar.gz`

**Components:**
- ASIC: Palladium2 (Cisco 8223-x model)
- SAI version: 1.16.1
- SDK version: 25.9.1000.2
- NGDP: Silicon One network simulator

### Pinned Commit

**Repository:** `https://github.com/sonic-net/sonic-buildimage.git`
**Branch:** 202505
**Commit:** `cb27941bb222fd953a3de228cc46391e373b43cf` (Sep 2025)

### Build Process

```bash
# Clone and checkout
git clone https://github.com/sonic-net/sonic-buildimage.git
cd sonic-buildimage
git checkout 202505
git checkout cb27941bb222fd953a3de228cc46391e373b43cf

# Build with CiscoVS platform tarball
./build.sh -b 202505 \
  -p /home/aldrin/Downloads/ciscovs-202505-palladium2-25.9.1000.2-sai-1.16.1.tar.gz \
  -j 16

# Output
ls -lh target/sonic-vs.img.gz
```

**Build Time:** 1-2 hours (depends on CPU)

**Output:** `target/sonic-vs.img.gz` (2-3GB compressed)

### Post-Build Conversion

```bash
# Extract
gunzip target/sonic-vs.img.gz

# Convert to qcow2
qemu-img convert -f raw -O qcow2 target/sonic-vs.img sonic-ciscovs.qcow2

# Install
mv sonic-ciscovs.qcow2 ~/.newtlab/images/
```

### Build Requirements

- Ubuntu 20.04 or Debian 11
- 100GB disk space (build artifacts are large)
- 16GB RAM minimum (32GB recommended)
- Docker installed
- SAI tarball downloaded

## Testing Considerations

### Validated Features

- ✅ Full L3 routing (2node-primitive, 3node-dataplane)
- ✅ BGP eBGP underlay + overlay (all suites)
- ✅ EVPN Type-2 MAC/IP — L2 bridging over VXLAN (3node-dataplane evpn-l2-irb)
- ✅ VXLAN tunnel creation (2node-service, 3node-dataplane)
- ✅ MAC-VPN L2 bridging over VXLAN (2node-service)
- ✅ VRFs with services (2node-primitive, 2node-service)
- ✅ Service apply/remove lifecycle (2node-service)
- ✅ Port channels (2node-primitive)

### Known Limitations

- ❌ EVPN L3 VNI routing — Silicon One SAI can't create `VNI_TO_VIRTUAL_ROUTER_ID` L3 DECAP entries (RCA-039)
- ⚠️ ACL offloading — not yet tested
- ⚠️ QoS policies — not yet tested

### Test Suite Compatibility

| Suite | Status |
|-------|--------|
| 2node-primitive | ✅ 20/20 PASS |
| 2node-service | ✅ 6/6 PASS |
| 3node-dataplane | ✅ 6/6 PASS |

### Current Test Status

**Last Validated:** Feb 2026

**Results:**
- 2node-primitive: ✅ 20/20 PASS
- 2node-service: ✅ 6/6 PASS (provision, health, dataplane, deprovision, verify-clean)
- 3node-dataplane: ✅ 6/6 PASS (L3 routing, EVPN L2 IRB)

## Performance Characteristics

- **Boot Time:** 5-10 minutes (depends on host)
- **BGP Convergence:** Similar to VPP (10-30s)
- **Memory Usage:** 4-5GB (8GB allocated)
- **CPU Usage:** Higher than VPP during packet processing
- **Dataplane Throughput:** TBD (NGDP simulation overhead)

## When to Use This Platform

**✅ Good For:**
- EVPN fabric testing
- VXLAN overlay validation
- Full SONiC feature testing
- Production-like scenarios
- ACL and QoS testing (expected)
- Multi-vendor interop scenarios

**❌ Not Good For:**
- Quick iteration (use VPP)
- Resource-constrained environments
- Parallel testing (high resource usage)
- Basic L3 routing validation (VPP faster)

## Migration from sonic-vpp

If switching from VPP to CiscoVS:

1. **Update platforms.json** entry (or keep both)
2. **Increase VM resources** in profiles (8GB RAM, 6 vCPU)
3. **Increase boot timeout** to 600s
4. **Remove unsupported_features** restrictions
5. **Add EVPN tests** that were skipped on VPP
6. **Allow longer boot/convergence times**

## Troubleshooting

### VM Fails to Boot

**Symptom:** VM hangs or crashes during boot

**Possible Causes:**
1. Insufficient memory (< 6GB)
2. Orchagent timeout too short
3. SAI initialization failure

**Debug:**
```bash
# Check serial console
newtlab console <device>

# Look for orchagent errors
# Should see SAI initialization messages
```

### VXLAN Tunnels Not Created

**Symptom:** FRR shows EVPN routes but no tunnels in ASIC_DB

**Check:**
```bash
# On device
show vxlan tunnel
show vxlan vni

# Should see tunnel endpoints
# VNIs should be active
```

**If empty:** Check orchagent logs for SAI errors

### High Packet Loss

**Symptom:** Ping tests show > 10% loss

**Investigate:**
1. NGDP simulator performance
2. Host resource saturation
3. Bridge/link stats
4. orchagent/syncd logs

## Related Documentation

- [RCA-022: CiscoVS Build Issues](../rca/022-sonic-202505-ciscovs-build-issues.md)
- [Platform Capabilities](../platform-capabilities.md)
- [EVPN HOWTO](../newtron/evpn-howto.md)
- [Device LLD](../newtron/device-lld.md)

## Future Work

- [ ] Test ACL offloading
- [ ] Test QoS policies
- [ ] Benchmark dataplane throughput
- [ ] Test EVPN multihoming
- [ ] Investigate L3 VNI on newer Silicon One SAI versions (RCA-039)
