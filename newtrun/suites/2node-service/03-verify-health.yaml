name: verify-health
description: |
  Capstone: run intent-based health checks on both switches.
  Verifies CONFIG_DB matches topology-derived expected state including
  VLANs, VLAN members, SVIs, EVPN VNIs, ARP suppression, service
  bindings, BGP sessions, and interface oper-up status.
topology: 2node-service
requires: [provision]

steps:
  # Ensure BGP sessions are established before running health checks.
  # The health check's BGP neighbor read is point-in-time (not polled),
  # so it races with convergence if run immediately after provision.
  - name: wait-bgp-established
    action: verify-bgp
    devices: [switch1, switch2]
    expect:
      state: Established
      timeout: 120s
      poll_interval: 5s

  - name: verify-health-switch1
    action: verify-health
    devices: [switch1]
    expect:
      overall: pass

  - name: verify-health-switch2
    action: verify-health
    devices: [switch2]
    expect:
      overall: pass
