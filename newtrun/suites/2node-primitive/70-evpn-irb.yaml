name: evpn-irb
description: |
  EVPN IRB (Integrated Routing and Bridging): create Vrf_irb with L3VNI 50002,
  configure SVI for VLAN 300 (from evpn-l2-bridge) as the distributed anycast
  gateway (same IP on both switches), and verify:
    1. IRB gateway reachability (hosts can ping their local SVI IP 10.3.0.1)
    2. L2 bridging within VLAN 300 still works (host2â†”host5 via VXLAN)
  Includes full CONFIG_DB verification for BindIPVPN tables.
topology: 2node
requires: [evpn-l2-bridge]

steps:
  # Create the IRB VRF on both switches.
  - name: create-vrf-irb-sw1
    action: create-vrf
    devices: [switch1]
    params:
      vrf: Vrf_irb

  - name: create-vrf-irb-sw2
    action: create-vrf
    devices: [switch2]
    params:
      vrf: Vrf_irb

  # Bind L3VNI 50002 to Vrf_irb.
  - name: bind-ipvpn-irb-sw1
    action: bind-ipvpn
    devices: [switch1]
    params:
      vrf: Vrf_irb
      ipvpn: evpn-irb-vrf

  - name: bind-ipvpn-irb-sw2
    action: bind-ipvpn
    devices: [switch2]
    params:
      vrf: Vrf_irb
      ipvpn: evpn-irb-vrf

  # CONFIG_DB verification: VRF with VNI binding
  - name: verify-vrf-irb-vni
    action: verify-config-db
    devices: [switch1]
    table: VRF
    key: Vrf_irb
    expect:
      fields:
        vni: "50002"

  # CONFIG_DB verification: BGP globals for VRF
  - name: verify-bgp-globals-vrf
    action: verify-config-db
    devices: [switch1]
    table: BGP_GLOBALS
    key: Vrf_irb
    expect:
      fields:
        local_asn: "65001"

  # CONFIG_DB verification: L2VPN EVPN AF with advertise
  - name: verify-bgp-af-l2vpn-evpn
    action: verify-config-db
    devices: [switch1]
    table: BGP_GLOBALS_AF
    key: "Vrf_irb|l2vpn_evpn"
    expect:
      fields:
        advertise-ipv4-unicast: "true"

  # CONFIG_DB verification: EVPN route target
  - name: verify-evpn-rt
    action: verify-config-db
    devices: [switch1]
    table: BGP_GLOBALS_EVPN_RT
    key: "Vrf_irb|L2VPN_EVPN|65000:50002"
    expect:
      exists: true

  # CONFIG_DB verification: route redistribution
  - name: verify-route-redistribute
    action: verify-config-db
    devices: [switch1]
    table: ROUTE_REDISTRIBUTE
    key: "Vrf_irb|connected|bgp|ipv4"
    expect:
      exists: true

  # Configure SVI for VLAN 300 with gateway IP in Vrf_irb on both switches.
  - name: configure-svi-sw1
    action: configure-svi
    devices: [switch1]
    vlan_id: 300
    params:
      ip: "10.3.0.1/24"
      vrf: Vrf_irb

  - name: configure-svi-sw2
    action: configure-svi
    devices: [switch2]
    vlan_id: 300
    params:
      ip: "10.3.0.1/24"
      vrf: Vrf_irb

  # CONFIG_DB verification: SVI with VRF
  - name: verify-svi-vrf-sw1
    action: verify-config-db
    devices: [switch1]
    table: VLAN_INTERFACE
    key: Vlan300
    expect:
      fields:
        vrf_name: Vrf_irb

  # CONFIG_DB verification: SVI IP
  - name: verify-svi-ip-sw1
    action: verify-config-db
    devices: [switch1]
    table: VLAN_INTERFACE
    key: "Vlan300|10.3.0.1/24"
    expect:
      exists: true

  # Wait for SAI SVI programming.
  - name: wait-svi-ready
    action: wait
    duration: 15s

  # Prime NGDP ARP responder for the SVI gateway from each switch.
  - name: prime-arp-sw1-svi
    action: ssh-command
    devices: [switch1]
    command: "for i in 1 2 3 4 5; do sudo ping -c 1 -W 2 -I Vlan300 10.3.0.2 && break; sleep 2; done || true"

  - name: prime-arp-sw2-svi
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5; do sudo ping -c 1 -W 2 -I Vlan300 10.3.0.5 && break; sleep 2; done || true"

  - name: wait-after-prime
    action: wait
    duration: 5s

  # Host-to-gateway: verify the SVI gateway is reachable.
  - name: host2-ping-svi-gateway
    action: host-exec
    devices: [host2]
    command: "ping -c 3 -W 2 10.3.0.1"
    expect:
      success_rate: 0.8

  - name: host5-ping-svi-gateway
    action: host-exec
    devices: [host5]
    command: "ping -c 3 -W 2 10.3.0.1"
    expect:
      success_rate: 0.8

  # Host-to-host dataplane: L2 bridging within VLAN 300 still works with SVI.
  - name: host2-ping-host5-l2
    action: host-exec
    devices: [host2]
    command: "ping -c 5 -W 2 10.3.0.5"
    expect:
      success_rate: 0.8

  - name: host5-ping-host2-l2
    action: host-exec
    devices: [host5]
    command: "ping -c 5 -W 2 10.3.0.2"
    expect:
      success_rate: 0.8
