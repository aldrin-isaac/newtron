name: cross-switch-routing
description: |
  Cross-switch L3 routing: assign IPs on sw1:Ethernet1 and sw2:Ethernet1 in
  the default VRF, verify BGP distributes connected routes, and test host-to-host
  reachability via routed path (host1 â†” host4 across two switches).
  Requires teardown-local (frees Ethernet1 on both switches) and bgp-underlay.
topology: 2node
requires: [teardown-local, bgp-underlay]

steps:
  - name: set-ip-eth1-switch1
    action: set-interface
    devices: [switch1]
    interface: Ethernet1
    params:
      property: ip
      value: "10.20.0.1/31"

  - name: set-ip-eth1-switch2
    action: set-interface
    devices: [switch2]
    interface: Ethernet1
    params:
      property: ip
      value: "10.20.1.1/31"

  # CONFIG_DB verification
  - name: verify-ip-sw1-eth1
    action: verify-config-db
    devices: [switch1]
    table: INTERFACE
    key: "Ethernet1|10.20.0.1/31"
    expect:
      exists: true

  - name: verify-ip-sw2-eth1
    action: verify-config-db
    devices: [switch2]
    table: INTERFACE
    key: "Ethernet1|10.20.1.1/31"
    expect:
      exists: true

  # Poll for kernel IPs
  - name: wait-eth1-ip-sw1
    action: ssh-command
    devices: [switch1]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do ip addr show Ethernet1 | grep -q '10.20.0.1' && break; sleep 5; done; true"

  - name: wait-eth1-ip-sw2
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do ip addr show Ethernet1 | grep -q '10.20.1.1' && break; sleep 5; done; true"

  # Verify BGP distributes connected routes (10.20.1.0/31 learned on sw1 via BGP)
  - name: verify-route-sw1
    action: verify-route
    devices: [switch1]
    prefix: "10.20.1.0/31"
    vrf: "default"
    expect:
      protocol: "bgp"
      timeout: 60s

  - name: verify-route-sw2
    action: verify-route
    devices: [switch2]
    prefix: "10.20.0.0/31"
    vrf: "default"
    expect:
      protocol: "bgp"
      timeout: 60s

  # Prime NGDP ARP
  - name: prime-arp-sw1-eth1
    action: ssh-command
    devices: [switch1]
    command: "for i in 1 2 3 4 5; do sudo ping -c 1 -W 2 -I Ethernet1 10.20.0.0 && break; sleep 2; done || true"

  - name: prime-arp-sw2-eth1
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5; do sudo ping -c 1 -W 2 -I Ethernet1 10.20.1.0 && break; sleep 2; done || true"

  - name: wait-after-prime
    action: wait
    duration: 3s

  # Configure host IPs
  - name: host1-configure-ip
    action: host-exec
    devices: [host1]
    command: "ip addr flush dev eth0 2>/dev/null; ip addr add 10.20.0.0/31 dev eth0; ip route add default via 10.20.0.1 dev eth0 2>/dev/null || true"

  - name: host4-configure-ip
    action: host-exec
    devices: [host4]
    command: "ip addr flush dev eth0 2>/dev/null; ip addr add 10.20.1.0/31 dev eth0; ip route add default via 10.20.1.1 dev eth0 2>/dev/null || true"

  # Host-to-host dataplane: routed path through two switches
  - name: host1-ping-host4
    action: host-exec
    devices: [host1]
    command: "ping -c 5 -W 2 10.20.1.0"
    expect:
      success_rate: 0.8

  - name: host4-ping-host1
    action: host-exec
    devices: [host4]
    command: "ping -c 5 -W 2 10.20.0.0"
    expect:
      success_rate: 0.8
