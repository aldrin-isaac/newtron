name: host-connectivity
description: Verify host namespace provisioning and underlay L3 reachability
topology: 2node
requires:
- provision

steps:
- name: host1-interface-has-ip
  action: host-exec
  devices:
  - host1
  command: "ip addr show dev eth0"
  expect:
    contains: "10.1.1.0"

- name: host1-default-route
  action: host-exec
  devices:
  - host1
  command: "ip route show"
  expect:
    contains: "default via 10.1.1.1"

- name: host1-ping-switch
  action: host-exec
  devices:
  - host1
  command: "ping -c 3 -W 2 10.1.1.1"
  expect:
    success_rate: 0.8

# host1 extended: ping switch1's loopback (verifies default route + local routing)
- name: host1-ping-switch1-loopback
  action: host-exec
  devices:
  - host1
  command: "ping -c 3 -W 2 10.0.0.1"
  expect:
    success_rate: 0.8

# Prime ARP for CUSTOMER VRF on switch2:Ethernet2 (RCA-033).
# NGDP's ARP responder only activates after an outbound packet. Pinging host5
# from switch2 sends ARP via Ethernet2 and activates the responder.
# Non-failing: side-effect only (retry 3 times, always exit 0).
- name: switch2-prime-customer-vrf
  action: ssh-command
  devices: [switch2]
  command: "for i in 1 2 3; do ping -c 1 -W 5 -I Ethernet2 10.10.1.0 && break; sleep 3; done; true"

# host5: connected to switch2:Ethernet2 (CUSTOMER VRF, 10.10.1.1/31)
# host5 IP is auto-derived as 10.10.1.0 with default route via 10.10.1.1
- name: host5-interface-has-ip
  action: host-exec
  devices:
  - host5
  command: "ip addr show dev eth0"
  expect:
    contains: "10.10.1.0"

- name: host5-default-route
  action: host-exec
  devices:
  - host5
  command: "ip route show"
  expect:
    contains: "default via 10.10.1.1"

- name: host5-ping-switch
  action: host-exec
  devices:
  - host5
  command: "ping -c 3 -W 2 10.10.1.1"
  expect:
    success_rate: 0.8
