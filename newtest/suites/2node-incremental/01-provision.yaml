name: provision
description: Provision all devices, restart BGP, apply FRR defaults, and verify CONFIG_DB state
topology: 2node
requires: [boot-ssh]

steps:
  - name: provision-all
    action: provision
    devices: all

  - name: verify-device-metadata-switch1
    action: verify-config-db
    devices: [switch1]
    table: DEVICE_METADATA
    key: localhost
    expect:
      exists: true

  - name: verify-device-metadata-switch2
    action: verify-config-db
    devices: [switch2]
    table: DEVICE_METADATA
    key: localhost
    expect:
      exists: true

  - name: verify-loopback-switch1
    action: verify-config-db
    devices: [switch1]
    table: LOOPBACK_INTERFACE
    expect:
      min_entries: 1

  - name: verify-loopback-switch2
    action: verify-config-db
    devices: [switch2]
    table: LOOPBACK_INTERFACE
    expect:
      min_entries: 1

  # Restart BGP containers to pick up the new CONFIG_DB entries.
  # config reload breaks VPP syncd (RCA-001), so restart bgp only.
  - name: restart-bgp
    action: restart-service
    devices: all
    service: bgp

  # Wait for FRR + frrcfgd to finish initial config render
  - name: wait-bgp-restart
    action: wait
    duration: 15s

  # Apply FRR defaults not supported by frrcfgd templates:
  # - no bgp ebgp-requires-policy
  # - no bgp suppress-fib-pending
  # - ttl-security for iBGP overlay neighbors with ebgp_multihop
  # - clear bgp * soft out (force route re-advertisement)
  - name: apply-frr-defaults
    action: apply-frr-defaults
    devices: all
