name: bgp-direct-neighbor
description: "Configure IPs and add/remove a direct eBGP neighbor on Ethernet1"
topology: 2node
requires: [provision]

steps:
  # Set IPs on both ends of the link
  - name: set-ip-switch1
    action: set-interface
    devices: [switch1]
    interface: Ethernet1
    params:
      property: ip
      value: "10.1.1.0/31"

  - name: set-ip-switch2
    action: set-interface
    devices: [switch2]
    interface: Ethernet1
    params:
      property: ip
      value: "10.1.1.1/31"

  # Add direct BGP neighbor on switch2
  # NOTE: No dataplane test here â€” switch1:Ethernet1 links to host1 and
  # switch2:Ethernet1 links to host4; they are on separate physical segments.
  # This scenario exercises CONFIG_DB BGP neighbor lifecycle only.
  - name: add-direct-neighbor
    action: bgp-add-neighbor
    devices: [switch2]
    interface: Ethernet1
    params:
      neighbor_ip: "10.1.1.0"
      remote_asn: 65001

  - name: verify-neighbor-exists
    action: verify-config-db
    devices: [switch2]
    table: BGP_NEIGHBOR
    key: "default|10.1.1.0"
    expect:
      exists: true

  # Remove the neighbor
  - name: remove-direct-neighbor
    action: bgp-remove-neighbor
    devices: [switch2]
    params:
      neighbor_ip: "10.1.1.0"

  - name: verify-neighbor-removed
    action: verify-config-db
    devices: [switch2]
    table: BGP_NEIGHBOR
    key: "default|10.1.1.0"
    expect:
      exists: false

  # Clean up IPs via ssh-command (set empty IP to remove)
  - name: cleanup-ip-switch1
    action: ssh-command
    devices: [switch1]
    command: "redis-cli -n 4 DEL 'INTERFACE|Ethernet1|10.1.1.0/31'"

  - name: cleanup-ip-switch2
    action: ssh-command
    devices: [switch2]
    command: "redis-cli -n 4 DEL 'INTERFACE|Ethernet1|10.1.1.1/31'"
