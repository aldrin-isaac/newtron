name: qos-datacenter
description: Apply server-irb service and verify 8q-datacenter QoS policy with ECN/WRED
topology: 2node
platform: sonic-vpp
requires: [vlan-lifecycle]

steps:
  - name: apply-server-irb
    action: apply-service
    devices: [leaf1]
    interface: Ethernet2
    service: server-irb

  # 8-queue DSCP mappings
  - name: verify-dscp-map-8q
    action: verify-config-db
    devices: [leaf1]
    table: DSCP_TO_TC_MAP
    key: 8q-datacenter
    expect:
      fields:
        "0": "0"
        "8": "1"
        "46": "5"
        "56": "7"

  # Scheduler count (8 queues = 8 schedulers)
  - name: verify-scheduler-count
    action: verify-config-db
    devices: [leaf1]
    table: SCHEDULER
    expect:
      min_entries: 8

  # WRED profile exists (ecn: true on lossless queues)
  - name: verify-wred-profile
    action: verify-config-db
    devices: [leaf1]
    table: WRED_PROFILE
    key: "8q-datacenter.ecn"
    expect:
      fields:
        ecn: ecn_all
        green_min_threshold: "1048576"
        green_max_threshold: "2097152"

  # Queue 3 (lossless) has WRED binding
  - name: verify-queue-wred-binding
    action: verify-config-db
    devices: [leaf1]
    table: QUEUE
    key: "Ethernet2|3"
    expect:
      fields:
        scheduler: "[SCHEDULER|8q-datacenter.3]"
        wred_profile: "[WRED_PROFILE|8q-datacenter.ecn]"

  # Queue 0 (best-effort) has NO wred_profile
  - name: verify-queue-no-wred
    action: verify-config-db
    devices: [leaf1]
    table: QUEUE
    key: "Ethernet2|0"
    expect:
      fields:
        scheduler: "[SCHEDULER|8q-datacenter.0]"

  # PORT_QOS_MAP binding
  - name: verify-port-qos-8q
    action: verify-config-db
    devices: [leaf1]
    table: PORT_QOS_MAP
    key: Ethernet2
    expect:
      fields:
        dscp_to_tc_map: "[DSCP_TO_TC_MAP|8q-datacenter]"

  - name: remove-service
    action: remove-service
    devices: [leaf1]
    interface: Ethernet2
