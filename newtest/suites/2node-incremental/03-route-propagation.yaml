name: route-propagation
description: Verify loopback routes propagate between spine and leaf
topology: 2node
requires: [bgp-converge]

steps:
  - name: switch2-loopback-at-switch1
    action: verify-route
    devices: [switch1]
    prefix: "10.0.0.2/32"
    vrf: default
    expect:
      protocol: bgp
      source: app_db
      timeout: 60s
      poll_interval: 5s

  - name: switch1-loopback-at-switch2
    action: verify-route
    devices: [switch2]
    prefix: "10.0.0.1/32"
    vrf: default
    expect:
      protocol: bgp
      source: app_db
      timeout: 60s
      poll_interval: 5s

  # Dataplane: confirm BGP routes are actually forwarding packets
  - name: ping-switch1-to-switch2-loopback
    action: verify-ping
    devices: [switch1]
    target: "10.0.0.2"
    count: 5
    expect:
      success_rate: 0.8

  - name: ping-switch2-to-switch1-loopback
    action: verify-ping
    devices: [switch2]
    target: "10.0.0.1"
    count: 5
    expect:
      success_rate: 0.8
