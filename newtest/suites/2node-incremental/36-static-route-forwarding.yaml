name: static-route-forwarding
description: "Static route dataplane: switch1 forwards packets to a new subnet on switch2 via a default-VRF static route over the transit link"
topology: 2node
requires: [static-route, vrf-routing, route-propagation]

steps:
  # Assign IP 172.16.100.1/24 to switch2:Ethernet3 in the default VRF.
  # Ethernet3 is free at this point (vrf-routing cleaned up its VRF binding and IP).
  # SetIP creates both the base INTERFACE|Ethernet3 and the IP sub-entry.
  - name: set-ip-switch2-ethernet3
    action: set-interface
    devices: [switch2]
    interface: Ethernet3
    params:
      property: ip
      value: "172.16.100.1/24"

  # Add a static route on switch1 for 172.16.100.0/24 via 10.1.0.0 (switch2's transit IP).
  # switch1:Ethernet0 is directly connected to switch2:Ethernet0 (10.1.0.0/31 transit link).
  - name: add-static-route-switch1
    action: add-static-route
    devices: [switch1]
    params:
      vrf: default
      prefix: "172.16.100.0/24"
      next_hop: "10.1.0.0"

  - name: verify-static-route-installed
    action: verify-config-db
    devices: [switch1]
    table: STATIC_ROUTE
    key: "172.16.100.0/24"
    expect:
      exists: true

  # Wait for orchagent to program IP on switch2:Ethernet3 and FIB entry on switch1.
  - name: wait-kernel-propagation
    action: wait
    duration: 5s

  # Ping from switch1 to 172.16.100.1 (switch2:Ethernet3 IP).
  # Forwarding path: switch1 → static route → 10.1.0.0 (switch2:Ethernet0) → 172.16.100.1 (Ethernet3).
  - name: ping-via-static-route
    action: verify-ping
    devices: [switch1]
    target: "172.16.100.1"
    count: 5
    expect:
      success_rate: 0.8

  # Cleanup: remove static route from switch1, then IP from switch2:Ethernet3.
  - name: remove-static-route
    action: remove-static-route
    devices: [switch1]
    params:
      vrf: default
      prefix: "172.16.100.0/24"

  - name: cleanup-switch2-ip
    action: ssh-command
    devices: [switch2]
    command: "redis-cli -n 4 DEL 'INTERFACE|Ethernet3|172.16.100.1/24'"
