name: service-l3
description: Apply customer-l3 service on switch2:Ethernet1 and verify
topology: 2node
requires: [vrf-lifecycle]

steps:
  - name: apply-customer-l3
    action: apply-service
    devices: [switch2]
    interface: Ethernet1
    service: customer-l3
    params:
      ip: "192.168.1.1/24"

  - name: verify-l3-binding
    action: verify-config-db
    devices: [switch2]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet1
    expect:
      fields:
        service_name: customer-l3

  # Dataplane: host4 is connected to switch2:Ethernet1.
  # Apply-service assigns 192.168.1.1/24 to Ethernet1 in the service VRF.
  # Wait for orchagent to propagate, configure host4 in the same subnet,
  # then verify host4 can reach the switch gateway.
  - name: wait-service-kernel-propagation
    action: wait
    duration: 5s

  - name: host4-configure-ip
    action: host-exec
    devices: [host4]
    command: "ip addr add 192.168.1.2/24 dev eth0 2>/dev/null || true"

  - name: host4-ping-service-gateway
    action: host-exec
    devices: [host4]
    command: "ping -c 3 -W 2 192.168.1.1"
    expect:
      success_rate: 0.8

  - name: host4-cleanup-ip
    action: host-exec
    devices: [host4]
    command: "ip addr del 192.168.1.2/24 dev eth0 2>/dev/null || true"
