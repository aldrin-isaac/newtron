name: portchannel-lifecycle
description: "PortChannel create/member-add/member-remove/delete lifecycle"
topology: 2node
requires: [provision]

steps:
  - name: create-portchannel
    action: create-portchannel
    devices: [switch2]
    params:
      name: PortChannel100
      members: [Ethernet1, Ethernet3]
      min_links: 1

  - name: verify-portchannel-exists
    action: verify-config-db
    devices: [switch2]
    table: PORTCHANNEL
    key: PortChannel100
    expect:
      exists: true

  - name: verify-member-eth1
    action: verify-config-db
    devices: [switch2]
    table: PORTCHANNEL_MEMBER
    key: "PortChannel100|Ethernet1"
    expect:
      exists: true

  - name: verify-member-eth3
    action: verify-config-db
    devices: [switch2]
    table: PORTCHANNEL_MEMBER
    key: "PortChannel100|Ethernet3"
    expect:
      exists: true

  - name: remove-member-eth3
    action: remove-portchannel-member
    devices: [switch2]
    params:
      name: PortChannel100
      member: Ethernet3

  - name: verify-member-eth3-removed
    action: verify-config-db
    devices: [switch2]
    table: PORTCHANNEL_MEMBER
    key: "PortChannel100|Ethernet3"
    expect:
      exists: false

  - name: verify-member-eth1-still-present
    action: verify-config-db
    devices: [switch2]
    table: PORTCHANNEL_MEMBER
    key: "PortChannel100|Ethernet1"
    expect:
      exists: true

  - name: add-member-eth3-back
    action: add-portchannel-member
    devices: [switch2]
    params:
      name: PortChannel100
      member: Ethernet3

  - name: verify-member-eth3-readded
    action: verify-config-db
    devices: [switch2]
    table: PORTCHANNEL_MEMBER
    key: "PortChannel100|Ethernet3"
    expect:
      exists: true

  - name: delete-portchannel
    action: delete-portchannel
    devices: [switch2]
    params:
      name: PortChannel100

  - name: verify-portchannel-removed
    action: verify-config-db
    devices: [switch2]
    table: PORTCHANNEL
    key: PortChannel100
    expect:
      exists: false

  - name: verify-members-removed
    action: verify-config-db
    devices: [switch2]
    table: PORTCHANNEL_MEMBER
    key: "PortChannel100|Ethernet1"
    expect:
      exists: false
