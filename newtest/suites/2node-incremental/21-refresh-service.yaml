name: refresh-service
description: Apply service, refresh it, verify binding persists, then remove
topology: 2node
platform: sonic-vpp
requires: [service-remove]

steps:
  - name: apply-customer-l3
    action: apply-service
    devices: [leaf1]
    interface: Ethernet1
    service: customer-l3
    params:
      ip: "192.168.1.1/24"

  - name: verify-binding-after-apply
    action: verify-config-db
    devices: [leaf1]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet1
    expect:
      fields:
        service: customer-l3

  - name: refresh-ethernet1
    action: refresh-service
    devices: [leaf1]
    interface: Ethernet1

  - name: verify-binding-after-refresh
    action: verify-config-db
    devices: [leaf1]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet1
    expect:
      fields:
        service: customer-l3

  - name: remove-service
    action: remove-service
    devices: [leaf1]
    interface: Ethernet1

  - name: verify-binding-removed
    action: verify-config-db
    devices: [leaf1]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet1
    expect:
      exists: false
