name: vrf-routing
description: "VRF routing dataplane: host6 reaches switch2 gateway through a dedicated VRF on Ethernet3"
topology: 2node
requires: [vrf-lifecycle]

steps:
  # Create Vrf_dp_test and bind switch2:Ethernet3 (â†’host6, no topology IP) to it.
  - name: create-vrf-dp
    action: create-vrf
    devices: [switch2]
    params:
      vrf: Vrf_dp_test

  # Bind Ethernet3 to VRF, then assign IP (same sequence as 05-interface-ip-vrf).
  - name: bind-ethernet3-to-vrf
    action: set-interface
    devices: [switch2]
    interface: Ethernet3
    params:
      property: vrf
      value: Vrf_dp_test

  - name: set-ip-ethernet3
    action: set-interface
    devices: [switch2]
    interface: Ethernet3
    params:
      property: ip
      value: "172.16.1.1/24"

  - name: verify-interface-in-vrf
    action: verify-config-db
    devices: [switch2]
    table: INTERFACE
    key: Ethernet3
    expect:
      fields:
        vrf_name: Vrf_dp_test

  - name: verify-ip-assigned
    action: verify-config-db
    devices: [switch2]
    table: INTERFACE
    key: "Ethernet3|172.16.1.1/24"
    expect:
      exists: true

  # Wait for orchagent to program the VRF interface and IP into the kernel.
  # CiscoVS NGDP needs ~30s to initialize the ARP responder for a new VRF interface.
  - name: wait-kernel-propagation
    action: wait
    duration: 30s

  # Configure host6 (connected to switch2:Ethernet3) with IP in the VRF subnet.
  - name: host6-configure-ip
    action: host-exec
    devices: [host6]
    command: "ip addr add 172.16.1.2/24 dev eth0 2>/dev/null || true"

  - name: host6-add-default-route
    action: host-exec
    devices: [host6]
    command: "ip route add default via 172.16.1.1 dev eth0 2>/dev/null || true"

  # Prime ARP from the switch side first (CiscoVS NGDP cold-start, see RCA-033).
  # NGDP's ARP responder for a new VRF interface only activates after the interface
  # sends at least one outgoing ARP request. Pinging host6 from switch2 causes NGDP
  # to send ARP via Ethernet3, which initialises the responder. After this, host6's
  # ARP requests for 172.16.1.1 are answered.
  # This step is intentionally non-failing: its purpose is only to send outbound ARPs
  # (side effect), not to verify connectivity. The actual test is host6-ping-gateway.
  # Retry up to 6 times in case NGDP isn't ready yet (30s wait above + up to 30s here).
  - name: switch2-prime-arp
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5 6; do ping -c 1 -W 5 -I Ethernet3 172.16.1.2 && break; sleep 5; done; true"

  # host6 pings switch2's Ethernet3 gateway (verifies VRF L3 forwarding works).
  - name: host6-ping-gateway
    action: host-exec
    devices: [host6]
    command: "ping -c 3 -W 2 172.16.1.1"
    expect:
      success_rate: 0.8

  # Cleanup: host6 networking, then switch2 IP, VRF binding, VRF.
  - name: host6-cleanup-route
    action: host-exec
    devices: [host6]
    command: "ip route del default 2>/dev/null || true"

  - name: host6-cleanup-ip
    action: host-exec
    devices: [host6]
    command: "ip addr del 172.16.1.2/24 dev eth0 2>/dev/null || true"

  - name: cleanup-ip
    action: ssh-command
    devices: [switch2]
    command: "redis-cli -n 4 DEL 'INTERFACE|Ethernet3|172.16.1.1/24'"

  - name: cleanup-unbind-vrf
    action: set-interface
    devices: [switch2]
    interface: Ethernet3
    params:
      property: vrf
      value: ""

  - name: cleanup-vrf
    action: delete-vrf
    devices: [switch2]
    params:
      vrf: Vrf_dp_test
