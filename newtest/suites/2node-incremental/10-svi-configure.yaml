name: svi-configure
description: Create VLAN + VRF, configure SVI, verify VLAN_INTERFACE entries
topology: 2node
requires:
- provision
steps:
- name: create-vlan500
  action: create-vlan
  devices:
  - switch2
  vlan_id: 500
- name: create-vrf-svi
  action: create-vrf
  devices:
  - switch2
  params:
    vrf: Vrf_svi
- name: configure-svi
  action: configure-svi
  devices:
  - switch2
  params:
    vrf: Vrf_svi
    ip: 10.1.50.1/24
  vlan_id: 500
- name: verify-svi-vrf
  action: verify-config-db
  devices:
  - switch2
  table: VLAN_INTERFACE
  key: Vlan500
  expect:
    fields:
      vrf_name: Vrf_svi
- name: verify-svi-ip
  action: verify-config-db
  devices:
  - switch2
  table: VLAN_INTERFACE
  key: Vlan500|10.1.50.1/24
  expect:
    exists: true
# Dataplane: wait for orchagent to create Vlan500 kernel interface and assign
# the IP in Vrf_svi, then confirm the IP is visible in the kernel.
- name: wait-svi-kernel-propagation
  action: wait
  duration: 5s
- name: verify-svi-kernel-ip
  action: ssh-command
  devices:
  - switch2
  command: "ip addr show dev Vlan500"
  expect:
    contains: "10.1.50.1"
- name: cleanup-svi-ip
  action: ssh-command
  devices:
  - switch2
  command: redis-cli -n 4 DEL 'VLAN_INTERFACE|Vlan500|10.1.50.1/24'
- name: cleanup-svi-vrf
  action: ssh-command
  devices:
  - switch2
  command: redis-cli -n 4 DEL 'VLAN_INTERFACE|Vlan500'
- name: cleanup-vrf
  action: delete-vrf
  devices:
  - switch2
  params:
    vrf: Vrf_svi
- name: cleanup-vlan
  action: delete-vlan
  devices:
  - switch2
  vlan_id: 500
