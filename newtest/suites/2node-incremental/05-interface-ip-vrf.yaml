name: interface-ip-vrf
description: Test interface IP and VRF binding via newtron set-interface API
topology: 2node
requires: [provision]

steps:
  - name: create-vrf-test
    action: create-vrf
    devices: [switch2]
    params:
      vrf: Vrf_test

  - name: set-vrf-ethernet1
    action: set-interface
    devices: [switch2]
    interface: Ethernet1
    params:
      property: vrf
      value: Vrf_test

  - name: verify-vrf-binding
    action: verify-config-db
    devices: [switch2]
    table: INTERFACE
    key: Ethernet1
    expect:
      fields:
        vrf_name: Vrf_test

  - name: set-ip-ethernet1
    action: set-interface
    devices: [switch2]
    interface: Ethernet1
    params:
      property: ip
      value: "192.168.99.1/24"

  - name: verify-ip-binding
    action: verify-config-db
    devices: [switch2]
    table: INTERFACE
    key: "Ethernet1|192.168.99.1/24"
    expect:
      exists: true

  # Dataplane: host4 is connected to switch2:Ethernet1.
  # Wait for orchagent to propagate VRF + IP to kernel, then verify host4 can
  # reach the switch gateway (traffic ingresses switch2:Ethernet1 in Vrf_test).
  - name: wait-kernel-propagation
    action: wait
    duration: 5s

  - name: host4-configure-ip
    action: host-exec
    devices: [host4]
    command: "ip addr add 192.168.99.2/24 dev eth0 2>/dev/null || true"

  - name: host4-ping-switch-gateway
    action: host-exec
    devices: [host4]
    command: "ping -c 3 -W 2 192.168.99.1"
    expect:
      success_rate: 0.8

  - name: host4-cleanup-ip
    action: host-exec
    devices: [host4]
    command: "ip addr del 192.168.99.2/24 dev eth0 2>/dev/null || true"

  # Cleanup: remove IP, unbind VRF, then delete VRF
  - name: cleanup-ip
    action: ssh-command
    devices: [switch2]
    command: "redis-cli -n 4 DEL 'INTERFACE|Ethernet1|192.168.99.1/24'"

  - name: cleanup-unbind-vrf
    action: set-interface
    devices: [switch2]
    interface: Ethernet1
    params:
      property: vrf
      value: ""

  - name: cleanup-vrf
    action: delete-vrf
    devices: [switch2]
    params:
      vrf: Vrf_test
