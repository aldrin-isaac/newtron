name: acl-lifecycle
description: ACL table/rule create-bind-unbind-delete lifecycle; exercises verify-state-db
topology: 2node
requires:
- provision

steps:
- name: create-acl-table
  action: create-acl-table
  devices:
  - switch2
  params:
    name: FILTER_TEST
    type: L3
    stage: ingress
    description: "Test ingress filter"

- name: add-acl-rule
  action: add-acl-rule
  devices:
  - switch2
  params:
    name: FILTER_TEST
    rule: RULE_ICMP
    priority: 100
    action: permit
    protocol: icmp

- name: bind-acl
  action: bind-acl
  devices:
  - switch2
  interface: Ethernet1
  params:
    name: FILTER_TEST
    direction: ingress

- name: verify-acl-table-exists
  action: verify-config-db
  devices:
  - switch2
  table: ACL_TABLE
  key: FILTER_TEST
  expect:
    exists: true

- name: verify-acl-rule-exists
  action: verify-config-db
  devices:
  - switch2
  table: ACL_RULE
  key: FILTER_TEST|RULE_ICMP
  expect:
    exists: true

# verify-state-db: confirm port is still operational after ACL binding
- name: verify-port-state-after-bind
  action: verify-state-db
  devices:
  - switch2
  table: PORT_TABLE
  key: Ethernet1
  expect:
    fields:
      oper_status: up
    timeout: 10s
    poll_interval: 2s

- name: unbind-acl
  action: unbind-acl
  devices:
  - switch2
  interface: Ethernet1
  params:
    name: FILTER_TEST

- name: delete-acl-rule
  action: delete-acl-rule
  devices:
  - switch2
  params:
    name: FILTER_TEST
    rule: RULE_ICMP

- name: delete-acl-table
  action: delete-acl-table
  devices:
  - switch2
  params:
    name: FILTER_TEST

- name: verify-acl-table-deleted
  action: verify-config-db
  devices:
  - switch2
  table: ACL_TABLE
  key: FILTER_TEST
  expect:
    exists: false
