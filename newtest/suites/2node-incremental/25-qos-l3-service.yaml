name: qos-l3-service
description: Apply customer-l3 service and verify 4q-customer QoS policy tables
topology: 2node
platform: sonic-vpp
requires: [vrf-lifecycle, service-remove]

steps:
  # Apply the service (QoS tables created as side-effect)
  - name: apply-customer-l3
    action: apply-service
    devices: [leaf1]
    interface: Ethernet1
    service: customer-l3
    params:
      ip: "192.168.1.1/24"

  # Verify device-wide QoS tables
  - name: verify-dscp-to-tc-map
    action: verify-config-db
    devices: [leaf1]
    table: DSCP_TO_TC_MAP
    key: 4q-customer
    expect:
      fields:
        "0": "0"
        "10": "1"
        "46": "2"
        "48": "3"

  - name: verify-tc-to-queue-map
    action: verify-config-db
    devices: [leaf1]
    table: TC_TO_QUEUE_MAP
    key: 4q-customer
    expect:
      fields:
        "0": "0"
        "1": "1"
        "2": "2"
        "3": "3"

  - name: verify-scheduler-dwrr
    action: verify-config-db
    devices: [leaf1]
    table: SCHEDULER
    key: "4q-customer.0"
    expect:
      fields:
        type: DWRR
        weight: "40"

  - name: verify-scheduler-strict
    action: verify-config-db
    devices: [leaf1]
    table: SCHEDULER
    key: "4q-customer.2"
    expect:
      fields:
        type: STRICT

  # Verify per-interface bindings
  - name: verify-port-qos-map
    action: verify-config-db
    devices: [leaf1]
    table: PORT_QOS_MAP
    key: Ethernet1
    expect:
      fields:
        dscp_to_tc_map: "[DSCP_TO_TC_MAP|4q-customer]"
        tc_to_queue_map: "[TC_TO_QUEUE_MAP|4q-customer]"

  - name: verify-queue-binding
    action: verify-config-db
    devices: [leaf1]
    table: QUEUE
    key: "Ethernet1|1"
    expect:
      fields:
        scheduler: "[SCHEDULER|4q-customer.1]"

  # Clean up
  - name: remove-service
    action: remove-service
    devices: [leaf1]
    interface: Ethernet1

  - name: verify-port-qos-removed
    action: verify-config-db
    devices: [leaf1]
    table: PORT_QOS_MAP
    key: Ethernet1
    expect:
      exists: false

  - name: verify-queue-removed
    action: verify-config-db
    devices: [leaf1]
    table: QUEUE
    key: "Ethernet1|0"
    expect:
      exists: false
