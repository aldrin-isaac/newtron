name: verify-clean
description: |
  Verify that CONFIG_DB is clean after full deprovision.
  For every forward action there must be a reverse action — this suite
  verifies that every CONFIG_DB entry written during provision has been
  removed. Organized by table to trace operational symmetry.
topology: 2node-service
requires: [deprovision]

steps:
  # =========================================================================
  # NEWTRON_SERVICE_BINDING — one per provisioned interface
  # Forward: ApplyService → binding entry
  # Reverse: RemoveService → deletes binding
  # =========================================================================

  - name: no-binding-eth0
    action: verify-config-db
    devices: [switch1, switch2]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet0
    expect:
      exists: false

  - name: no-binding-eth1
    action: verify-config-db
    devices: [switch1, switch2]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet1
    expect:
      exists: false

  - name: no-binding-eth2
    action: verify-config-db
    devices: [switch1, switch2]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet2
    expect:
      exists: false

  - name: no-binding-eth3
    action: verify-config-db
    devices: [switch1, switch2]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet3
    expect:
      exists: false

  - name: no-binding-eth4
    action: verify-config-db
    devices: [switch1, switch2]
    table: NEWTRON_SERVICE_BINDING
    key: Ethernet4
    expect:
      exists: false

  # =========================================================================
  # INTERFACE — routed service (transit) creates base + IP sub-entry
  # Forward: enableIpRouting + assignIpAddress
  # Reverse: RemoveService → unassignIpAddress + disableIpRouting
  # =========================================================================

  - name: no-interface-eth0
    action: verify-config-db
    devices: [switch1, switch2]
    table: INTERFACE
    key: Ethernet0
    expect:
      exists: false

  # switch1: 10.1.0.0/31, switch2: 10.1.0.1/31
  - name: no-interface-eth0-ip-sw1
    action: verify-config-db
    devices: [switch1]
    table: INTERFACE
    key: "Ethernet0|10.1.0.0/31"
    expect:
      exists: false

  - name: no-interface-eth0-ip-sw2
    action: verify-config-db
    devices: [switch2]
    table: INTERFACE
    key: "Ethernet0|10.1.0.1/31"
    expect:
      exists: false

  # =========================================================================
  # VLAN — one per macvpn (100, 200, 300, 400, 401, 3998 L3VNI)
  # Forward: createVlan
  # Reverse: RemoveService → destroyVlan (last user gate)
  # =========================================================================

  - name: no-vlan100
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN
    key: Vlan100
    expect:
      exists: false

  - name: no-vlan200
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN
    key: Vlan200
    expect:
      exists: false

  - name: no-vlan300
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN
    key: Vlan300
    expect:
      exists: false

  - name: no-vlan400
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN
    key: Vlan400
    expect:
      exists: false

  - name: no-vlan401
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN
    key: Vlan401
    expect:
      exists: false

  # L3VNI VLAN for Vrf_irb (evpn-irb shared VRF)
  - name: no-vlan3998
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN
    key: Vlan3998
    expect:
      exists: false

  # =========================================================================
  # VLAN_MEMBER — one per interface+VLAN binding
  # Forward: createVlanMember
  # Reverse: RemoveService → deleteVlanMember
  # =========================================================================

  # local-irb: Ethernet1 tagged member of Vlan100
  - name: no-vlan-member-100-eth1
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN_MEMBER
    key: "Vlan100|Ethernet1"
    expect:
      exists: false

  # local-bridge: Ethernet2 untagged member of Vlan200
  - name: no-vlan-member-200-eth2
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN_MEMBER
    key: "Vlan200|Ethernet2"
    expect:
      exists: false

  # l2-extend: Ethernet3 untagged member of Vlan300
  - name: no-vlan-member-300-eth3
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN_MEMBER
    key: "Vlan300|Ethernet3"
    expect:
      exists: false

  # overlay-irb-a: Ethernet4 tagged member of Vlan400 (switch1 only)
  - name: no-vlan-member-400-eth4
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN_MEMBER
    key: "Vlan400|Ethernet4"
    expect:
      exists: false

  # overlay-irb-b: Ethernet4 tagged member of Vlan401 (switch2 only)
  - name: no-vlan-member-401-eth4
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN_MEMBER
    key: "Vlan401|Ethernet4"
    expect:
      exists: false

  # =========================================================================
  # VLAN_INTERFACE — SVI for irb and evpn-irb services
  # Forward: createSVI + assignSviIp / createAnycastSVI
  # Reverse: RemoveService → deleteSviIp + deleteSVI
  # =========================================================================

  # local-irb SVI on Vlan100
  - name: no-svi-vlan100
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN_INTERFACE
    key: Vlan100
    expect:
      exists: false

  # overlay-irb-a SVI on Vlan400 (switch1)
  - name: no-svi-vlan400
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN_INTERFACE
    key: Vlan400
    expect:
      exists: false

  # overlay-irb-b SVI on Vlan401 (switch2)
  - name: no-svi-vlan401
    action: verify-config-db
    devices: [switch1, switch2]
    table: VLAN_INTERFACE
    key: Vlan401
    expect:
      exists: false

  # =========================================================================
  # SAG_GLOBAL — anycast gateway MAC (shared across all evpn-irb SVIs)
  # Forward: createSagGlobal (first anycast MAC user)
  # Reverse: RemoveService → deleteSagGlobal (last anycast MAC user)
  # =========================================================================

  - name: no-sag-global
    action: verify-config-db
    devices: [switch1, switch2]
    table: SAG_GLOBAL
    key: IPv4
    expect:
      exists: false

  # =========================================================================
  # VRF — shared VRF for evpn-irb
  # Forward: createVrf
  # Reverse: RemoveService → destroyVrf (last IPVPN user)
  # =========================================================================

  - name: no-vrf-irb
    action: verify-config-db
    devices: [switch1, switch2]
    table: VRF
    key: Vrf_irb
    expect:
      exists: false

  # =========================================================================
  # VXLAN_TUNNEL_MAP — VNI-to-VLAN/VRF mappings
  # Forward: createVniMap
  # Reverse: RemoveService → deleteVniMap
  # =========================================================================

  # l2-extend: VNI 10300 → Vlan300
  - name: no-vni-map-10300
    action: verify-config-db
    devices: [switch1, switch2]
    table: VXLAN_TUNNEL_MAP
    key: "vtep1|map_10300_Vlan300"
    expect:
      exists: false

  # overlay-irb-a: VNI 10400 → Vlan400
  - name: no-vni-map-10400
    action: verify-config-db
    devices: [switch1, switch2]
    table: VXLAN_TUNNEL_MAP
    key: "vtep1|map_10400_Vlan400"
    expect:
      exists: false

  # overlay-irb-b: VNI 10401 → Vlan401
  - name: no-vni-map-10401
    action: verify-config-db
    devices: [switch1, switch2]
    table: VXLAN_TUNNEL_MAP
    key: "vtep1|map_10401_Vlan401"
    expect:
      exists: false

  # L3VNI: VNI 50400 → Vrf_irb
  - name: no-vni-map-50400
    action: verify-config-db
    devices: [switch1, switch2]
    table: VXLAN_TUNNEL_MAP
    key: "vtep1|map_50400_Vrf_irb"
    expect:
      exists: false

  # =========================================================================
  # SUPPRESS_VLAN_NEIGH — ARP suppression on EVPN VLANs
  # Forward: enableArpSuppression
  # Reverse: RemoveService → disableArpSuppression
  # =========================================================================

  - name: no-arp-suppress-vlan300
    action: verify-config-db
    devices: [switch1, switch2]
    table: SUPPRESS_VLAN_NEIGH
    key: Vlan300
    expect:
      exists: false

  - name: no-arp-suppress-vlan400
    action: verify-config-db
    devices: [switch1, switch2]
    table: SUPPRESS_VLAN_NEIGH
    key: Vlan400
    expect:
      exists: false

  - name: no-arp-suppress-vlan401
    action: verify-config-db
    devices: [switch1, switch2]
    table: SUPPRESS_VLAN_NEIGH
    key: Vlan401
    expect:
      exists: false

  # =========================================================================
  # BGP_EVPN_VNI — per-VNI BGP config (route targets)
  # Forward: createBgpEvpnVni
  # Reverse: RemoveService → deleteBgpEvpnVni
  # =========================================================================

  - name: no-bgp-evpn-vni-10300
    action: verify-config-db
    devices: [switch1, switch2]
    table: BGP_EVPN_VNI
    key: "default|10300"
    expect:
      exists: false

  - name: no-bgp-evpn-vni-10400
    action: verify-config-db
    devices: [switch1, switch2]
    table: BGP_EVPN_VNI
    key: "default|10400"
    expect:
      exists: false

  - name: no-bgp-evpn-vni-10401
    action: verify-config-db
    devices: [switch1, switch2]
    table: BGP_EVPN_VNI
    key: "default|10401"
    expect:
      exists: false

  # =========================================================================
  # BGP_GLOBALS_EVPN_RT — VRF route targets for EVPN
  # Forward: bindIpvpn → createBgpEvpnRT
  # Reverse: RemoveService → unbindIpvpn → deleteBgpEvpnRT
  # =========================================================================

  - name: no-bgp-evpn-rt-vrf-irb
    action: verify-config-db
    devices: [switch1, switch2]
    table: BGP_GLOBALS_EVPN_RT
    key: Vrf_irb
    expect:
      exists: false

  # =========================================================================
  # VXLAN_TUNNEL — VTEP (infrastructure)
  # Forward: SetupEVPN → CreateVTEP
  # Reverse: TeardownEVPN → delete VTEP
  # =========================================================================

  - name: no-vtep
    action: verify-config-db
    devices: [switch1, switch2]
    table: VXLAN_TUNNEL
    key: vtep1
    expect:
      exists: false

  # =========================================================================
  # VXLAN_EVPN_NVO — NVO (infrastructure)
  # Forward: SetupEVPN → create NVO
  # Reverse: TeardownEVPN → delete NVO
  # =========================================================================

  - name: no-nvo
    action: verify-config-db
    devices: [switch1, switch2]
    table: VXLAN_EVPN_NVO
    key: nvo1
    expect:
      exists: false

  # =========================================================================
  # BGP_GLOBALS — global BGP configuration
  # Forward: ConfigureBGP → CreateBGPGlobals
  # Reverse: RemoveBGPGlobals → delete BGP_GLOBALS
  # =========================================================================

  - name: no-bgp-globals
    action: verify-config-db
    devices: [switch1, switch2]
    table: BGP_GLOBALS
    key: default
    expect:
      exists: false

  # =========================================================================
  # BGP_GLOBALS_AF — address-family configs (ipv4_unicast, l2vpn_evpn)
  # Forward: ConfigureBGP + SetupEVPN
  # Reverse: TeardownEVPN (l2vpn_evpn) + RemoveBGPGlobals (ipv4_unicast)
  # =========================================================================

  - name: no-bgp-af-ipv4
    action: verify-config-db
    devices: [switch1, switch2]
    table: BGP_GLOBALS_AF
    key: "default|ipv4_unicast"
    expect:
      exists: false

  - name: no-bgp-af-l2vpn
    action: verify-config-db
    devices: [switch1, switch2]
    table: BGP_GLOBALS_AF
    key: "default|l2vpn_evpn"
    expect:
      exists: false

  # =========================================================================
  # ROUTE_REDISTRIBUTE — connected route redistribution
  # Forward: ConfigureBGP → CreateRouteRedistribute
  # Reverse: RemoveBGPGlobals → delete ROUTE_REDISTRIBUTE
  # =========================================================================

  - name: no-route-redistribute
    action: verify-config-db
    devices: [switch1, switch2]
    table: ROUTE_REDISTRIBUTE
    key: "default|connected|ipv4"
    expect:
      exists: false

  # =========================================================================
  # BGP_NEIGHBOR — underlay peers (transit) + overlay peers (EVPN)
  # Forward: ApplyService (transit) + SetupEVPN (overlay)
  # Reverse: RemoveService (transit) + TeardownEVPN (overlay)
  # =========================================================================

  # Underlay: switch1 peers with 10.1.0.1 (switch2), switch2 peers with 10.1.0.0 (switch1)
  - name: no-bgp-neighbor-underlay-sw1
    action: verify-config-db
    devices: [switch1]
    table: BGP_NEIGHBOR
    key: "default|10.1.0.1"
    expect:
      exists: false

  - name: no-bgp-neighbor-underlay-sw2
    action: verify-config-db
    devices: [switch2]
    table: BGP_NEIGHBOR
    key: "default|10.1.0.0"
    expect:
      exists: false

  # Overlay: switch1 peers with 10.0.0.2 (switch2 loopback), switch2 peers with 10.0.0.1
  - name: no-bgp-neighbor-overlay-sw1
    action: verify-config-db
    devices: [switch1]
    table: BGP_NEIGHBOR
    key: "default|10.0.0.2"
    expect:
      exists: false

  - name: no-bgp-neighbor-overlay-sw2
    action: verify-config-db
    devices: [switch2]
    table: BGP_NEIGHBOR
    key: "default|10.0.0.1"
    expect:
      exists: false

  # =========================================================================
  # LOOPBACK_INTERFACE — baseline loopback
  # Forward: ApplyBaseline → LOOPBACK_INTERFACE entries
  # Reverse: RemoveBaseline → delete all Loopback0 entries
  # =========================================================================

  - name: no-loopback
    action: verify-config-db
    devices: [switch1, switch2]
    table: LOOPBACK_INTERFACE
    key: Loopback0
    expect:
      exists: false

  - name: no-loopback-ip-sw1
    action: verify-config-db
    devices: [switch1]
    table: LOOPBACK_INTERFACE
    key: "Loopback0|10.0.0.1/32"
    expect:
      exists: false

  - name: no-loopback-ip-sw2
    action: verify-config-db
    devices: [switch2]
    table: LOOPBACK_INTERFACE
    key: "Loopback0|10.0.0.2/32"
    expect:
      exists: false
