name: deprovision
description: |
  Deprovision all services and infrastructure from both switches.
  Uses symmetric reverse actions for every forward action in the provisioner:
    ApplyService   → RemoveService    (per-interface, reverse dependency order)
    SetupEVPN      → TeardownEVPN     (VTEP, NVO, overlay peers)
    ConfigureBGP   → RemoveBGPGlobals (BGP globals, AF, redistribution)
    ApplyBaseline  → RemoveBaseline   (loopback interface)
  Validates the "no config leak" principle: every CONFIG_DB entry written
  by a forward action is removed by its corresponding reverse action.
topology: 2node-service
requires: [provision]
after: [dataplane]

steps:
  # =========================================================================
  # Reverse of ApplyService — per-interface, reverse dependency order
  # Forward:  iface.ApplyService(ctx, serviceName, opts)
  # Reverse:  iface.RemoveService(ctx)
  # =========================================================================

  # Remove EVPN overlay services first (have VXLAN dependencies)
  - name: remove-overlay-irb-switch1
    action: remove-service
    devices: [switch1]
    interface: Ethernet4

  - name: remove-overlay-irb-switch2
    action: remove-service
    devices: [switch2]
    interface: Ethernet4

  - name: remove-l2-extend-switch1
    action: remove-service
    devices: [switch1]
    interface: Ethernet3

  - name: remove-l2-extend-switch2
    action: remove-service
    devices: [switch2]
    interface: Ethernet3

  # Remove local services
  - name: remove-local-bridge-switch1
    action: remove-service
    devices: [switch1]
    interface: Ethernet2

  - name: remove-local-bridge-switch2
    action: remove-service
    devices: [switch2]
    interface: Ethernet2

  - name: remove-local-irb-switch1
    action: remove-service
    devices: [switch1]
    interface: Ethernet1

  - name: remove-local-irb-switch2
    action: remove-service
    devices: [switch2]
    interface: Ethernet1

  # Remove transit (underlay BGP) last
  - name: remove-transit-switch1
    action: remove-service
    devices: [switch1]
    interface: Ethernet0

  - name: remove-transit-switch2
    action: remove-service
    devices: [switch2]
    interface: Ethernet0

  # =========================================================================
  # Reverse of SetupEVPN — VTEP, NVO, overlay peers
  # Forward:  node.SetupEVPN(ctx, loopbackIP)
  # Reverse:  node.TeardownEVPN(ctx)
  # =========================================================================

  - name: teardown-evpn
    action: teardown-evpn
    devices: [switch1, switch2]

  # =========================================================================
  # Reverse of ConfigureBGP — BGP globals, AF, redistribution
  # Forward:  node.ConfigureBGP(ctx)
  # Reverse:  node.RemoveBGPGlobals(ctx)
  # =========================================================================

  - name: remove-bgp-globals
    action: remove-bgp-globals
    devices: [switch1, switch2]

  # =========================================================================
  # Reverse of ApplyBaseline — loopback interface
  # Forward:  node.ApplyBaseline(ctx, "sonic-baseline", vars)
  # Reverse:  node.RemoveBaseline(ctx)
  # =========================================================================

  - name: remove-baseline
    action: remove-baseline
    devices: [switch1, switch2]
