name: l2-vxlan
description: L2 VXLAN - create VLAN 100 + MACVPN on both leafs, verify bidirectional L2 connectivity
topology: 3node
platform: sonic-vpp
requires: [boot-provision]

steps:
  # Create VLAN 100 on both leafs
  - name: create-vlan-leaf1
    action: create-vlan
    devices: [leaf1]
    params:
      vlan_id: 100

  - name: create-vlan-leaf2
    action: create-vlan
    devices: [leaf2]
    params:
      vlan_id: 100

  # Add host-facing ports to VLAN 100
  - name: add-member-leaf1
    action: add-vlan-member
    devices: [leaf1]
    params:
      vlan_id: 100
      interface: Ethernet2

  - name: add-member-leaf2
    action: add-vlan-member
    devices: [leaf2]
    params:
      vlan_id: 100
      interface: Ethernet2

  # Bind MACVPN (L2 VXLAN tunnel)
  - name: bind-macvpn-leaf1
    action: bind-macvpn
    devices: [leaf1]
    params:
      vlan_id: 100
      macvpn: servers-vlan100

  - name: bind-macvpn-leaf2
    action: bind-macvpn
    devices: [leaf2]
    params:
      vlan_id: 100
      macvpn: servers-vlan100

  # Verify VXLAN mapping in CONFIG_DB
  - name: verify-vxlan-leaf1
    action: verify-config-db
    devices: [leaf1]
    table: VXLAN_TUNNEL_MAP
    key: vtep|map_10100_Vlan100
    expect:
      fields:
        vni: "10100"
        vlan: Vlan100

  - name: verify-vxlan-leaf2
    action: verify-config-db
    devices: [leaf2]
    table: VXLAN_TUNNEL_MAP
    key: vtep|map_10100_Vlan100
    expect:
      fields:
        vni: "10100"
        vlan: Vlan100

  # Wait for EVPN convergence
  - name: wait-evpn
    action: wait
    duration: 10s

  # Bidirectional L2 ping through VXLAN tunnel
  - name: ping-host1-to-host2
    action: host-exec
    devices: [host1]
    command: "ping -c 5 -W 2 10.1.100.20"
    expect:
      success_rate: 0.8

  - name: ping-host2-to-host1
    action: host-exec
    devices: [host2]
    command: "ping -c 5 -W 2 10.1.100.10"
    expect:
      success_rate: 0.8
