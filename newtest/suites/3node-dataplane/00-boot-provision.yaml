name: boot-provision
description: Boot, provision leaf switches, verify BGP convergence and host reachability
topology: 3node
platform: sonic-vpp

steps:
  - name: ssh-echo-leaf1
    action: ssh-command
    devices: [leaf1]
    command: "echo ok"
    expect:
      contains: "ok"

  - name: ssh-echo-leaf2
    action: ssh-command
    devices: [leaf2]
    command: "echo ok"
    expect:
      contains: "ok"

  # Verify hosts are reachable via SSH (through parent VM namespace)
  - name: host1-echo
    action: host-exec
    devices: [host1]
    command: "echo ok"
    expect:
      contains: "ok"

  - name: host2-echo
    action: host-exec
    devices: [host2]
    command: "echo ok"
    expect:
      contains: "ok"

  - name: provision-leafs
    action: provision
    devices: [leaf1, leaf2]

  # Restart BGP containers to pick up the new CONFIG_DB entries.
  # config reload breaks VPP syncd (RCA-001), so restart bgp only.
  - name: restart-bgp
    action: restart-service
    devices: [leaf1, leaf2]
    service: bgp

  # Wait for FRR + frrcfgd to finish initial config render
  # CiscoVS platform takes longer than VPP to stabilize BGP container
  - name: wait-bgp-restart
    action: wait
    duration: 30s

  # Apply FRR defaults not supported by frrcfgd templates
  - name: apply-frr-defaults
    action: apply-frr-defaults
    devices: [leaf1, leaf2]

  - name: wait-bgp-init
    action: wait
    duration: 10s

  - name: verify-bgp
    action: verify-bgp
    devices: [leaf1, leaf2]
    expect:
      state: Established
      timeout: 120s
      poll_interval: 5s
