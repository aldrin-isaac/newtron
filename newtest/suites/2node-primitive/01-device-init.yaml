name: device-init
description: |
  Write system MAC to DEVICE_METADATA and start vlanmgrd/vxlanmgrd.
  CiscoVS factory CONFIG_DB is missing DEVICE_METADATA.mac (RCA-035),
  causing vlanmgrd/vxlanmgrd to FATAL on boot. Read the MAC from the
  factory config_db.json and inject it via redis-cli before daemons start.
topology: 2node
requires: [boot-ssh]

steps:
  # Read factory MAC from /etc/sonic/config_db.json and write to Redis CONFIG_DB.
  # python3 parses the JSON, redis-cli writes it atomically.
  # This is the same approach used by the provision step (RCA-035).
  - name: inject-mac-switch1
    action: ssh-command
    devices: [switch1]
    command: >-
      MAC=$(python3 -c "import json; d=json.load(open('/etc/sonic/config_db.json')); print(d.get('DEVICE_METADATA',{}).get('localhost',{}).get('mac',''))") &&
      [ -n "$MAC" ] && sudo redis-cli -n 4 HSET 'DEVICE_METADATA|localhost' mac "$MAC" || true

  - name: inject-mac-switch2
    action: ssh-command
    devices: [switch2]
    command: >-
      MAC=$(python3 -c "import json; d=json.load(open('/etc/sonic/config_db.json')); print(d.get('DEVICE_METADATA',{}).get('localhost',{}).get('mac',''))") &&
      [ -n "$MAC" ] && sudo redis-cli -n 4 HSET 'DEVICE_METADATA|localhost' mac "$MAC" || true

  # Start vlanmgrd/vxlanmgrd â€” may be in FATAL state at boot due to missing MAC.
  # '|| true' is safe on platforms where these daemons start normally.
  - name: start-vlan-daemons
    action: ssh-command
    devices: all
    command: "sudo docker exec swss supervisorctl start vlanmgrd vxlanmgrd 2>&1 || true"

  # Verify DEVICE_METADATA exists in CONFIG_DB
  - name: verify-device-metadata-switch1
    action: verify-config-db
    devices: [switch1]
    table: DEVICE_METADATA
    key: localhost
    expect:
      exists: true

  - name: verify-device-metadata-switch2
    action: verify-config-db
    devices: [switch2]
    table: DEVICE_METADATA
    key: localhost
    expect:
      exists: true
