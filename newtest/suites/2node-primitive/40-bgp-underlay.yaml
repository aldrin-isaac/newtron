name: bgp-underlay
description: |
  BGP underlay bringup: configure BGP globals, set Ethernet0 IPs, add eBGP
  neighbors across the inter-switch link, and verify Established.
  Builds on loopback-setup (Loopback0 IPs already set).
  Uses configure-bgp (new primitive) instead of provision.

  Dependency ordering (critical):
    1. Write BGP_GLOBALS and DEVICE_METADATA.bgp_asn — but NOT BGP_NEIGHBOR yet.
    2. Set INTERFACE IPs on Ethernet0; poll for kernel IP (intfmgrd assignment).
    3. restart-bgp — bgpcfgd starts with NO BGP_NEIGHBOR in CONFIG_DB.
       It programs the BGP instance cleanly without deferred-and-forgotten neighbors.
    4. poll-bgp-instance — wait for 'router bgp NNNNN' in show running-config.
       This confirms bgpcfgd (BGPGlobalCfgMgr) has fully initialized.
    5. bgp-add-neighbor — write BGP_NEIGHBOR AFTER bgpcfgd is initialized.
       bgpcfgd receives a fresh CONFIG_DB SET event with all deps met → programs neighbor.
    6. wait-bgpcfgd-settle — 10s for bgpcfgd to regenerate frr.conf after neighbor add.
    7. apply-frr-defaults — after bgpcfgd's frr.conf generation, apply extra settings.
    8. verify-bgp — poll until Established.

topology: 2node
requires: [loopback-setup]

steps:
  # Step 1: Write BGP_GLOBALS + DEVICE_METADATA.bgp_asn.
  - name: configure-bgp-switch1
    action: configure-bgp
    devices: [switch1]

  - name: configure-bgp-switch2
    action: configure-bgp
    devices: [switch2]

  # CONFIG_DB verification: BGP globals
  - name: verify-bgp-globals-sw1
    action: verify-config-db
    devices: [switch1]
    table: BGP_GLOBALS
    key: default
    expect:
      fields:
        local_asn: "65001"

  - name: verify-bgp-globals-sw2
    action: verify-config-db
    devices: [switch2]
    table: BGP_GLOBALS
    key: default
    expect:
      fields:
        local_asn: "65002"

  # Step 2: Set inter-switch link IPs on Ethernet0.
  - name: set-ip-eth0-switch1
    action: set-interface
    devices: [switch1]
    interface: Ethernet0
    params:
      property: ip
      value: "10.1.0.0/31"

  - name: set-ip-eth0-switch2
    action: set-interface
    devices: [switch2]
    interface: Ethernet0
    params:
      property: ip
      value: "10.1.0.1/31"

  # Step 3: Poll for Ethernet0 IP in kernel on BOTH switches BEFORE restart.
  - name: wait-eth0-ip-sw1
    action: ssh-command
    devices: [switch1]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12; do ip addr show Ethernet0 | grep -q '10.1.0.0' && break; sleep 5; done; true"

  - name: wait-eth0-ip-sw2
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12; do ip addr show Ethernet0 | grep -q '10.1.0.1' && break; sleep 5; done; true"

  # Step 4: Restart BGP to pick up new ASN (factory FRR has AS 65100; RCA-019).
  - name: restart-bgp
    action: restart-service
    devices: [switch1, switch2]
    service: bgp

  # Step 5: Poll for 'router bgp' in FRR running-config.
  - name: wait-bgp-instance-sw1
    action: ssh-command
    devices: [switch1]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do sudo vtysh -c 'show running-config' 2>/dev/null | grep -q 'router bgp' && break; sleep 3; done; true"

  - name: wait-bgp-instance-sw2
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do sudo vtysh -c 'show running-config' 2>/dev/null | grep -q 'router bgp' && break; sleep 3; done; true"

  # Step 6: Write BGP_NEIGHBOR AFTER bgpcfgd is fully initialized.
  - name: bgp-add-neighbor-switch1
    action: bgp-add-neighbor
    devices: [switch1]
    interface: Ethernet0
    params:
      remote_asn: 65002

  - name: bgp-add-neighbor-switch2
    action: bgp-add-neighbor
    devices: [switch2]
    interface: Ethernet0
    params:
      remote_asn: 65001

  # CONFIG_DB verification: BGP neighbor exists
  - name: verify-bgp-neighbor-sw1
    action: verify-config-db
    devices: [switch1]
    table: BGP_NEIGHBOR
    key: "default|10.1.0.1"
    expect:
      exists: true

  - name: verify-bgp-neighbor-sw2
    action: verify-config-db
    devices: [switch2]
    table: BGP_NEIGHBOR
    key: "default|10.1.0.0"
    expect:
      exists: true

  # Step 7: Wait for frrcfgd to regenerate frr.conf after programming the neighbor.
  - name: wait-frrcfgd-settle
    action: wait
    duration: 10s

  # Step 8: Apply FRR defaults not supported by bgpcfgd templates (RCA-034).
  - name: apply-frr-defaults
    action: apply-frr-defaults
    devices: [switch1, switch2]

  # Step 9: Verify underlay BGP sessions reach Established.
  - name: verify-bgp-underlay-switch1
    action: verify-bgp
    devices: [switch1]
    expect:
      state: Established
      timeout: 120s
      poll_interval: 5s

  - name: verify-bgp-underlay-switch2
    action: verify-bgp
    devices: [switch2]
    expect:
      state: Established
      timeout: 120s
      poll_interval: 5s
