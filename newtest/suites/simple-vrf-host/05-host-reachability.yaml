name: host-reachability
description: >
  Verify host5→switch2:Ethernet2 (CUSTOMER VRF) reachability.
  Primes NGDP ARP responder from switch side (RCA-033), then verifies host can ping.
  This scenario runs after the incremental VRF setup (create-vrf → bind-interface → set-ip)
  so orchagent has fully programmed the SAI data plane before we try connectivity.
topology: 2node
requires: [set-ip]

steps:
  # Configure host5's IP and default route (host5:eth0 is connected to switch2:Ethernet2).
  # host5 has no pre-configured IP (unlike provision-based setup) so we set it here.
  - name: host5-configure-ip
    action: host-exec
    devices: [host5]
    command: "ip addr add 10.10.1.0/31 dev eth0 2>/dev/null || true"

  - name: host5-configure-default-route
    action: host-exec
    devices: [host5]
    command: "ip route add default via 10.10.1.1 dev eth0 2>/dev/null || true"

  # Verify host5 has the expected IP.
  - name: host5-has-ip
    action: host-exec
    devices: [host5]
    command: "ip addr show dev eth0"
    expect:
      contains: "10.10.1.0"

  # Prime NGDP ARP responder (CiscoVS requirement, RCA-033).
  # NGDP requires an outbound ARP from the switch interface before responding to
  # inbound ARPs from the host. 'sudo ping -I Ethernet2' sends an ARP from switch
  # to host5 (10.10.1.0), activating the responder for 10.10.1.1 on Ethernet2.
  # This step FAILS if NGDP is not ready (intentional — no || true).
  - name: prime-ngdp-arp
    action: ssh-command
    devices: [switch2]
    command: "sudo ping -c 2 -W 5 -I Ethernet2 10.10.1.0"

  - name: wait-after-prime
    action: wait
    duration: 3s

  # Verify: host5 can ping switch2's CUSTOMER VRF gateway.
  - name: host5-ping-gateway
    action: host-exec
    devices: [host5]
    command: "ping -c 3 -W 2 10.10.1.1"
    expect:
      success_rate: 0.8
