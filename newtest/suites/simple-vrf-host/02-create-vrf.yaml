name: create-vrf
description: >
  Step 1 of incremental VRF setup: create CUSTOMER VRF on switch2, then verify it
  is programmed in the kernel (vrfmgrd) AND in ASIC_DB (orchagent/SAI).
  Uses polling instead of fixed waits since CiscoVS Silicon One SAI is slow.
topology: 2node
requires: [device-init]

steps:
  # Create CUSTOMER VRF via newtron primitive.
  # Writes VRF|CUSTOMER to CONFIG_DB. vrfmgrd processes → kernel VRF device →
  # writes APP_DB VRF_TABLE. orchagent processes APP_DB → SAI virtual router → ASIC_DB.
  - name: create-customer-vrf
    action: create-vrf
    devices: [switch2]
    params:
      vrf: CUSTOMER

  # Verify VRF|CUSTOMER is in CONFIG_DB.
  - name: verify-vrf-config-db
    action: verify-config-db
    devices: [switch2]
    table: VRF
    key: CUSTOMER
    expect:
      exists: true

  # Poll for vrfmgrd to create CUSTOMER kernel VRF device (typically fast, <5s).
  - name: poll-vrf-in-kernel
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5 6; do ip vrf show | grep -q CUSTOMER && break; sleep 5; done; true"

  # Verify vrfmgrd created CUSTOMER in kernel.
  - name: verify-vrf-in-kernel
    action: ssh-command
    devices: [switch2]
    command: "ip vrf show"
    expect:
      contains: "CUSTOMER"

  # Poll for orchagent to program the SAI virtual router in ASIC_DB.
  # CiscoVS Silicon One SAI is slow — can take 30-60s. Poll up to 90s.
  - name: poll-vrf-in-asicdb
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do redis-cli -n 1 keys 'ASIC_STATE:SAI_OBJECT_TYPE_VIRTUAL_ROUTER:*' | wc -l | grep -qE '[2-9]|[0-9]{2}' && break; sleep 5; done; true"

  # Verify CUSTOMER VRF SAI object exists in ASIC_DB (count ≥2: default + CUSTOMER).
  - name: verify-vrf-in-asicdb
    action: ssh-command
    devices: [switch2]
    command: "redis-cli -n 1 keys 'ASIC_STATE:SAI_OBJECT_TYPE_VIRTUAL_ROUTER:*' | wc -l"
    expect:
      contains: "2"
