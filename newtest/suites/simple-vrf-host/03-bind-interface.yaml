name: bind-interface
description: >
  Step 2 of incremental VRF setup: bind switch2:Ethernet2 to CUSTOMER VRF.
  Writes to CONFIG_DB and waits for intfmgrd to process the VRF binding naturally.
  intfmgrd checks APP_DB VRF_TABLE (not kernel) before binding — must exist from create-vrf.
topology: 2node
requires: [create-vrf]

steps:
  # Verify APP_DB VRF_TABLE|CUSTOMER exists (written by vrfmgrd after VRF creation).
  # intfmgrd checks this table before binding an interface to VRF. If missing, it waits.
  - name: verify-appdb-vrf-table
    action: ssh-command
    devices: [switch2]
    command: "redis-cli -n 0 keys 'VRF_TABLE:*'"
    expect:
      contains: "CUSTOMER"

  # Bind Ethernet2 to CUSTOMER VRF via newtron primitive.
  # Writes INTERFACE|Ethernet2 vrf_name=CUSTOMER to CONFIG_DB.
  # intfmgrd notification received → checks APP_DB VRF_TABLE → calls
  # 'ip link set Ethernet2 master CUSTOMER' → updates APP_DB INTF_TABLE.
  - name: bind-ethernet2-to-customer-vrf
    action: set-interface
    devices: [switch2]
    interface: Ethernet2
    params:
      property: vrf
      value: CUSTOMER

  # Verify CONFIG_DB was written.
  - name: verify-vrf-binding-config-db
    action: verify-config-db
    devices: [switch2]
    table: INTERFACE
    key: Ethernet2
    expect:
      fields:
        vrf_name: CUSTOMER

  # Poll for intfmgrd to process the VRF binding in the kernel.
  # On CiscoVS, intfmgrd processes keyspace notifications asynchronously.
  # Poll up to 60s to allow for SONiC daemon processing time.
  - name: poll-ethernet2-master-customer
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12; do ip link show Ethernet2 | grep -q 'master CUSTOMER' && break; sleep 5; done; true"

  # Diagnostic: show Ethernet2 kernel state and intfmgrd status.
  # This shows what state intfmgrd left the interface in.
  - name: show-ethernet2-state
    action: ssh-command
    devices: [switch2]
    command: "ip link show Ethernet2; sudo docker exec swss supervisorctl status intfmgrd 2>&1"

  # Verify kernel VRF binding. Fails with diagnostic output if intfmgrd didn't process.
  - name: verify-ethernet2-master-customer
    action: ssh-command
    devices: [switch2]
    command: "ip link show Ethernet2"
    expect:
      contains: "master CUSTOMER"

  # Poll for orchagent to create SAI router interface for Ethernet2 in ASIC_DB.
  - name: poll-router-interface-in-asicdb
    action: ssh-command
    devices: [switch2]
    command: "for i in 1 2 3 4 5 6 7 8 9 10 11 12; do redis-cli -n 1 keys 'ASIC_STATE:SAI_OBJECT_TYPE_ROUTER_INTERFACE:*' | wc -l | grep -qE '[1-9]' && break; sleep 5; done; true"

  # Verify SAI router interface exists in ASIC_DB.
  - name: verify-router-interface-in-asicdb
    action: ssh-command
    devices: [switch2]
    command: "redis-cli -n 1 keys 'ASIC_STATE:SAI_OBJECT_TYPE_ROUTER_INTERFACE:*' | wc -l"
    expect:
      contains: "1"
